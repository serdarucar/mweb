<div class="ui container">
  <div class="ui container" ng-controller="deliveryCtrl">
    <div class="ui four huge statistics">
      <div ng-click="showTotal()" class="grey huge statistic" style="cursor:pointer">
        <div id="{{result.sid}}:process" class="value mail-process">
          {{result.process}}
        </div>
        <div class="label">
          TOTAL
        </div>
      </div>
      <div ng-click="showSent()" class="green huge statistic" style="cursor:pointer">
        <div id="{{result.sid}}:sent" class="value mail-sent">
          {{result.sent}}
        </div>
        <div class="label">
          SENT
        </div>
      </div>
      <div ng-click="showDefer()" class="yellow huge statistic" style="cursor:pointer">
        <div id="{{result.sid}}:deferred" class="value mail-deferred">
          {{result.deferred}}
        </div>
        <div class="label">
          RETRY
        </div>
      </div>
      <div ng-click="showBounce()" class="red huge statistic" style="cursor:pointer">
        <div id="{{result.sid}}:bounced" class="value mail-bounced">
          {{result.bounced}}
        </div>
        <div class="label">
          UNSENT
        </div>
      </div>
    </div>
    <br>
    <div class="progress mail-prog-bar">
      <div id="{{result.sid}}:sprog" class="progress-bar progress-bar-success sent-mail-prog-bar" style="width: 0%"></div>
      <div id="{{result.sid}}:dprog" class="progress-bar progress-bar-warning defer-mail-prog-bar" style="width: 0%"></div>
      <div id="{{result.sid}}:bprog" class="progress-bar progress-bar-danger bounce-mail-prog-bar" style="width: 0%"></div>
    </div>
    <div class="well">
      <div class="ui two column grid">
        <div class="ui left aligned column">
          <h3><b>{{result.subject}}</b></h3>
        </div>
        <div class="ui right aligned column">
          <h3>{{prettifyDate result.time}} {{prettifyTime result.time}}</h3>
        </div>
      </div>
      <div class="ui two column grid">
        <div class="ui left aligned column">
          {{#each result.rcpt}}
          <span class="ui big basic black label">{{this}}</span>
          {{/each}}
        </div>
        <div class="ui right aligned column">
          {{result.count}} mails received by server
        </div>
      </div>
    </div>
    <div ng-hide="mailContent" ng-init="sid='{{result.sid}}'" id="mail-content" class="well" style="display: block;">
      <h4><b>MAIL BODY:</b></h4>
      <hr>
      {{{result.mbody}}}
    </div>
    <div ng-show="mailContent" class="well">
      <div class="ui two column grid">
        <div class="ui left aligned column">
          <div class="ui massive button" ng-click="showMail()"><  MAIL BODY</div>
        </div>
        <div class="ui right aligned column">
          <div class="ui icon input">
            <input ng-model="mailQuery" type="text" placeholder="SEARCH" />
          </div>
        </div>
      </div>
      <hr>
      <span class="ui medium basic grey label" ng-hide="totalContent" ng-repeat="mail in deliveryTotal | filter: mailQuery" style="cursor:pointer">{[{mail.to}]}</span>
      <span class="ui medium basic green label" ng-hide="sentContent" ng-repeat="mail in deliverySent | filter: mailQuery" style="cursor:pointer">{[{mail.to}]}</span>
      <span class="ui medium basic yellow label" ng-hide="deferContent" ng-repeat="mail in deliveryDefer | filter: mailQuery" style="cursor:pointer">{[{mail.to}]}</span>
      <span class="ui basic red label" ng-hide="bounceContent" ng-repeat="mail in deliveryBounce | filter: mailQuery" style="cursor:pointer">{[{mail.to}]}</span>
    </div>
    <div id="session-id" style="display: none;">{{result.sid}}</div>
    <div id="{{result.sid}}:total" style="display: none;">{{result.count}}</div>
  </div>
</div>
<script>

  $(document).ready(function() {
    var ssid = document.getElementById("session-id").innerHTML;
    var total = document.getElementById(ssid + ':total').innerHTML;
    var sent = document.getElementById(ssid + ':sent').innerHTML;
    var defer = document.getElementById(ssid + ':deferred').innerHTML;
    var bounce = document.getElementById(ssid + ':bounced').innerHTML;

    var sentPer = Math.round(sent / total * 100);
    var deferPer = Math.round(defer / total * 100);
    var bouncePer = Math.round(bounce / total * 100);

    var procPer = sentPer + deferPer + bouncePer;

    if (procPer > 100) {
      bouncePer = bouncePer - 1;
      procPer = procPer - 1;
    }

    //if (procPer == 100)
    //  $('.mail-prog-bar').toggleClass('active progress-striped');

    document.getElementById(ssid + ':sprog').style.width = sentPer + '%';
    document.getElementById(ssid + ':dprog').style.width = deferPer + '%';
    document.getElementById(ssid + ':bprog').style.width = bouncePer + '%';
  });

  var io = io.connect();
  io.on("mailstats", function(data) {
    document.getElementById(data.new_val.sid + ':sent').innerHTML = data.new_val.sent;
    document.getElementById(data.new_val.sid + ':deferred').innerHTML = data.new_val.deferred;
    document.getElementById(data.new_val.sid + ':bounced').innerHTML = data.new_val.bounced;
    document.getElementById(data.new_val.sid + ':process').innerHTML = data.new_val.sent + data.new_val.deferred + data.new_val.bounced;

    var totalCount = data.new_val.count;
    var sentPerc = Math.round(data.new_val.sent / totalCount * 100);
    var deferPerc = Math.round(data.new_val.deferred / totalCount * 100);
    var bouncePerc = Math.round(data.new_val.bounced / totalCount * 100);

    var procPerc = sentPerc + deferPerc + bouncePerc;

    if (procPerc > 100) {
      bouncePerc = bouncePerc - 1;
      procPerc = procPerc - 1;
    }

    //if (procPerc == 100)
    //  $('.mail-prog-bar').toggleClass('active progress-striped');

    document.getElementById(data.new_val.sid + ':sprog').style.width = sentPerc + '%';
    document.getElementById(data.new_val.sid + ':dprog').style.width = deferPerc + '%';
    document.getElementById(data.new_val.sid + ':bprog').style.width = bouncePerc + '%';

    // console.log('sent %: ' + sentPerc + ' - defer %: ' + deferPerc + ' - bounce %: ' + bouncePerc + ' - proc %:' + procPerc);

  });

</script>
